var KBEngine=KBEngine||{};KBEngine.Class=function(){},KBEngine.Class.extend=function(e){function n(){initializing||(this.ctor?this.ctor.apply(this,arguments):this.__nativeObj&&KBEngine.INFO_MSG("No ctor function found!"))}var t=this.prototype;initializing=!0;var i=Object.create(t);initializing=!1,fnTest=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/;for(var a in e)i[a]="function"==typeof e[a]&&"function"==typeof t[a]&&fnTest.test(e[a])?function(e,n){return function(){var i=this._super;this._super=t[e];var a=n.apply(this,arguments);return this._super=i,a}}(a,e[a]):e[a];return n.prototype=i,n.prototype.constructor=n,n.extend=arguments.callee,n},KBEngine.PACKET_MAX_SIZE=1500,KBEngine.PACKET_MAX_SIZE_TCP=1460,KBEngine.PACKET_MAX_SIZE_UDP=1472,KBEngine.MESSAGE_ID_LENGTH=2,KBEngine.MESSAGE_LENGTH_LENGTH=2,KBEngine.CLIENT_NO_FLOAT=0,KBEngine.KBE_FLT_MAX=3.402823466e38,KBEngine.INT64=function(e,n){this.lo=e,this.hi=n,this.sign=1,n>=2147483648&&(this.sign=-1,this.lo>0?(this.lo=4294967296-this.lo&4294967295,this.hi=4294967295-this.hi):(this.lo=4294967296-this.lo&4294967295,this.hi=4294967296-this.hi)),this.toString=function(){var e="";this.sign<0&&(e+="-");var n=this.lo.toString(16),t=this.hi.toString(16);if(this.hi>0){e+=t;for(var i=8-n.length;i>0;--i)e+="0"}return e+=n}},KBEngine.UINT64=function(e,n){this.lo=e,this.hi=n,this.toString=function(){var e=this.lo.toString(16),n=this.hi.toString(16),t="";if(this.hi>0){t+=n;for(var i=8-e.length;i>0;--i)t+="0"}return t+=e}},KBEngine.INFO_MSG=function(e){cc.info(e)},KBEngine.DEBUG_MSG=function(e){cc.debug(e)},KBEngine.ERROR_MSG=function(e){cc.error(e)},KBEngine.WARNING_MSG=function(e){cc.warn(e)},KBEngine.utf8ArrayToString=function(e){var n,t,i,a,r,s;for(n="",i=e.length,t=0;t<i;)switch(a=e[t++],a>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:n+=String.fromCharCode(a);break;case 12:case 13:r=e[t++],n+=String.fromCharCode((31&a)<<6|63&r);break;case 14:r=e[t++],s=e[t++],n+=String.fromCharCode((15&a)<<12|(63&r)<<6|(63&s)<<0)}return n},KBEngine.stringToUTF8Bytes=function(e){for(var n=[],t=0;t<e.length;t++){var i=e.charCodeAt(t);i<128?n.push(i):i<2048?n.push(192|i>>6,128|63&i):i<55296||i>=57344?n.push(224|i>>12,128|i>>6&63,128|63&i):(t++,i=65536+((1023&i)<<10|1023&e.charCodeAt(t)),n.push(240|i>>18,128|i>>12&63,128|i>>6&63,128|63&i))}return n},KBEngine.EventInfo=function(e,n){this.callbackfn=n,this.classinst=e},KBEngine.Event=function(){this._events={},this.register=function(evtName,classinst,strCallback){var callbackfn=eval("classinst."+strCallback);if(void 0==callbackfn)return void KBEngine.ERROR_MSG("KBEngine.Event::fire: not found strCallback("+classinst+")!"+strCallback);var evtlst=this._events[evtName];void 0==evtlst&&(evtlst=[],this._events[evtName]=evtlst);var info=new KBEngine.EventInfo(classinst,callbackfn);evtlst.push(info)},this.deregister=function(e,n){for(itemkey in this._events)for(var t=this._events[itemkey];;){for(var i=!1,a=0;a<t.length;a++){var r=t[a];if(r.classinst==n){t.splice(a,1),i=!0;break}}if(!i)break}},this.fire=function(){if(cc.log("外掛fire"),arguments.length<1)return void KBEngine.ERROR_MSG("KBEngine.Event::fire: not found eventName!");var e=arguments[0],n=this._events[e];if(void 0!=n){for(var t=[],i=1;i<arguments.length;i++)t.push(arguments[i]);for(var i=0;i<n.length;i++){var a=n[i];arguments.length<1?a.callbackfn.apply(a.classinst):a.callbackfn.apply(a.classinst,t)}}}},KBEngine.Event=new KBEngine.Event,KBEngine.MemoryStream=function(e){e instanceof ArrayBuffer?this.buffer=e:this.buffer=new ArrayBuffer(e),this.rpos=0,this.wpos=0,KBEngine.MemoryStream.PackFloatXType=function(){this._unionData=new ArrayBuffer(4),this.fv=new Float32Array(this._unionData,0,1),this.uv=new Uint32Array(this._unionData,0,1),this.iv=new Int32Array(this._unionData,0,1)},this.readInt8=function(){var e=new Int8Array(this.buffer,this.rpos,1);return this.rpos+=1,e[0]},this.readInt16=function(){var e=this.readUint16();return e>=32768&&(e-=65536),e},this.readInt32=function(){var e=this.readUint32();return e>=2147483648&&(e-=4294967296),e},this.readInt64=function(){return new KBEngine.INT64(this.readUint32(),this.readUint32())},this.readUint8=function(){var e=new Uint8Array(this.buffer,this.rpos,1);return this.rpos+=1,e[0]},this.readUint16=function(){var e=new Uint8Array(this.buffer,this.rpos);return this.rpos+=2,((255&e[1])<<8)+(255&e[0])},this.readUint32=function(){var e=new Uint8Array(this.buffer,this.rpos);return this.rpos+=4,(e[3]<<24)+(e[2]<<16)+(e[1]<<8)+e[0]},this.readUint64=function(){return new KBEngine.UINT64(this.readUint32(),this.readUint32())},this.readFloat=function(){try{var e=new Float32Array(this.buffer,this.rpos,1)}catch(n){var e=new Float32Array(this.buffer.slice(this.rpos,this.rpos+4))}return this.rpos+=4,e[0]},this.readDouble=function(){try{var e=new Float64Array(this.buffer,this.rpos,1)}catch(n){var e=new Float64Array(this.buffer.slice(this.rpos,this.rpos+8),0,1)}return this.rpos+=8,e[0]},this.readString=function(){for(var e=new Uint8Array(this.buffer,this.rpos),n=0,t="";;){if(0==e[n]){n++;break}if(t+=String.fromCharCode(e[n]),n++,this.rpos+n>=this.buffer.byteLength)throw new Error("KBEngine.MemoryStream::readString: rpos("+(this.rpos+n)+")>="+this.buffer.byteLength+" overflow!")}return this.rpos+=n,t},this.readBlob=function(){size=this.readUint32();var e=new Uint8Array(this.buffer,this.rpos,size);return this.rpos+=size,e},this.readStream=function(){var e=new Uint8Array(this.buffer,this.rpos,this.buffer.byteLength-this.rpos);return this.rpos=this.buffer.byteLength,new KBEngine.MemoryStream(e)},this.readPackXZ=function(){var e=new KBEngine.MemoryStream.PackFloatXType,n=new KBEngine.MemoryStream.PackFloatXType;e.fv[0]=0,n.fv[0]=0,e.uv[0]=1073741824,n.uv[0]=1073741824;var t=this.readUint8(),i=this.readUint8(),a=this.readUint8(),r=0;r|=t<<16,r|=i<<8,r|=a,e.uv[0]|=(8384512&r)<<3,n.uv[0]|=(2047&r)<<15,e.fv[0]-=2,n.fv[0]-=2,e.uv[0]|=(8388608&r)<<8,n.uv[0]|=(2048&r)<<20;var r=new Array(2);return r[0]=e.fv[0],r[1]=n.fv[0],r},this.readPackY=function(){var e=this.readUint16();return e},this.writeInt8=function(e){var n=new Int8Array(this.buffer,this.wpos,1);n[0]=e,this.wpos+=1},this.writeInt16=function(e){this.writeInt8(255&e),this.writeInt8(e>>8&255)},this.writeInt32=function(e){for(i=0;i<4;i++)this.writeInt8(e>>8*i&255)},this.writeInt64=function(e){this.writeInt32(e.lo),this.writeInt32(e.hi)},this.writeUint8=function(e){var n=new Uint8Array(this.buffer,this.wpos,1);n[0]=e,this.wpos+=1},this.writeUint16=function(e){this.writeUint8(255&e),this.writeUint8(e>>8&255)},this.writeUint32=function(e){for(i=0;i<4;i++)this.writeUint8(e>>8*i&255)},this.writeUint64=function(e){this.writeUint32(e.lo),this.writeUint32(e.hi)},this.writeFloat=function(e){try{var n=new Float32Array(this.buffer,this.wpos,1);n[0]=e}catch(t){var n=new Float32Array(1);n[0]=e;var i=new Uint8Array(this.buffer),a=new Uint8Array(n.buffer);i.set(a,this.wpos)}this.wpos+=4},this.writeDouble=function(e){try{var n=new Float64Array(this.buffer,this.wpos,1);n[0]=e}catch(t){var n=new Float64Array(1);n[0]=e;var i=new Uint8Array(this.buffer),a=new Uint8Array(n.buffer);i.set(a,this.wpos)}this.wpos+=8},this.writeBlob=function(e){if(size=e.length,size+4>this.space())return void KBEngine.ERROR_MSG("memorystream::writeBlob: no free!");this.writeUint32(size);var n=new Uint8Array(this.buffer,this.wpos,size);if("string"==typeof e)for(i=0;i<size;i++)n[i]=e.charCodeAt(i);else for(i=0;i<size;i++)n[i]=e[i];this.wpos+=size},this.writeString=function(e){if(e.length>this.space())return void KBEngine.ERROR_MSG("memorystream::writeString: no free!");var n=new Uint8Array(this.buffer,this.wpos),t=0;for(idx=0;idx<e.length;idx++)n[t++]=e.charCodeAt(idx);n[t++]=0,this.wpos+=t},this.readSkip=function(e){this.rpos+=e},this.space=function(){return this.buffer.byteLength-this.wpos},this.length=function(){return this.wpos-this.rpos},this.readEOF=function(){return this.buffer.byteLength-this.rpos<=0},this.done=function(){this.rpos=this.wpos},this.getbuffer=function(e){return this.buffer.slice(this.rpos,this.wpos)}},KBEngine.Bundle=function(){this.memorystreams=new Array,this.stream=new KBEngine.MemoryStream(KBEngine.PACKET_MAX_SIZE_TCP),this.numMessage=0,this.messageLengthBuffer=null,this.messageLength=0,this.msgtype=null,this.newMessage=function(e){this.fini(!1),this.msgtype=e,this.numMessage+=1,this.msgtype.length==-1&&(this.messageLengthBuffer=new Uint8Array(this.stream.buffer,this.stream.wpos+KBEngine.MESSAGE_ID_LENGTH,2)),this.writeUint16(e.id),this.messageLengthBuffer&&(this.writeUint16(0),this.messageLengthBuffer[0]=0,this.messageLengthBuffer[1]=0,this.messageLength=0)},this.writeMsgLength=function(e){this.messageLengthBuffer&&(this.messageLengthBuffer[0]=255&e,this.messageLengthBuffer[1]=e>>8&255)},this.fini=function(e){this.numMessage>0&&(this.writeMsgLength(this.messageLength),this.stream&&this.memorystreams.push(this.stream)),e&&(this.messageLengthBuffer=null,this.numMessage=0,this.msgtype=null)},this.send=function(e){for(this.fini(!0),i=0;i<this.memorystreams.length;i++)stream=this.memorystreams[i],e.send(stream.getbuffer());this.memorystreams=new Array,this.stream=new KBEngine.MemoryStream(KBEngine.PACKET_MAX_SIZE_TCP)},this.checkStream=function(e){e>this.stream.space()&&(this.memorystreams.push(this.stream),this.stream=new KBEngine.MemoryStream(KBEngine.PACKET_MAX_SIZE_TCP)),this.messageLength+=e},this.writeInt8=function(e){this.checkStream(1),this.stream.writeInt8(e)},this.writeInt16=function(e){this.checkStream(2),this.stream.writeInt16(e)},this.writeInt32=function(e){this.checkStream(4),this.stream.writeInt32(e)},this.writeInt64=function(e){this.checkStream(8),this.stream.writeInt64(e)},this.writeUint8=function(e){this.checkStream(1),this.stream.writeUint8(e)},this.writeUint16=function(e){this.checkStream(2),this.stream.writeUint16(e)},this.writeUint32=function(e){this.checkStream(4),this.stream.writeUint32(e)},this.writeUint64=function(e){this.checkStream(8),this.stream.writeUint64(e)},this.writeFloat=function(e){this.checkStream(4),this.stream.writeFloat(e)},this.writeDouble=function(e){this.checkStream(8),this.stream.writeDouble(e)},this.writeString=function(e){this.checkStream(e.length+1),this.stream.writeString(e)},this.writeBlob=function(e){this.checkStream(e.length+4),this.stream.writeBlob(e)}},KBEngine.reader=new KBEngine.MemoryStream(0),KBEngine.datatype2id={},KBEngine.mappingDataType=function(e,n){KBEngine.datatype2id={},KBEngine.datatype2id.STRING=1,KBEngine.datatype2id["STD::STRING"]=1,KBEngine.datatype2id.UINT8=2,KBEngine.datatype2id.BOOL=2,KBEngine.datatype2id.DATATYPE=2,KBEngine.datatype2id.CHAR=2,KBEngine.datatype2id.DETAIL_TYPE=2,KBEngine.datatype2id.MAIL_TYPE=2,KBEngine.datatype2id.UINT16=3,KBEngine.datatype2id["UNSIGNED SHORT"]=3,KBEngine.datatype2id.SERVER_ERROR_CODE=3,KBEngine.datatype2id.ENTITY_TYPE=3,KBEngine.datatype2id.ENTITY_PROPERTY_UID=3,KBEngine.datatype2id.ENTITY_METHOD_UID=3,KBEngine.datatype2id.ENTITY_SCRIPT_UID=3,KBEngine.datatype2id.DATATYPE_UID=3,KBEngine.datatype2id.UINT32=4,KBEngine.datatype2id.UINT=4,KBEngine.datatype2id["UNSIGNED INT"]=4,KBEngine.datatype2id.ARRAYSIZE=4,KBEngine.datatype2id.SPACE_ID=4,KBEngine.datatype2id.GAME_TIME=4,KBEngine.datatype2id.TIMER_ID=4,KBEngine.datatype2id.UINT64=5,KBEngine.datatype2id.DBID=5,KBEngine.datatype2id.COMPONENT_ID=5,KBEngine.datatype2id.INT8=6,KBEngine.datatype2id.COMPONENT_ORDER=6,KBEngine.datatype2id.INT16=7,KBEngine.datatype2id.SHORT=7,KBEngine.datatype2id.INT32=8,KBEngine.datatype2id.INT=8,KBEngine.datatype2id.ENTITY_ID=8,KBEngine.datatype2id.CALLBACK_ID=8,KBEngine.datatype2id.COMPONENT_TYPE=8,KBEngine.datatype2id.INT64=9,KBEngine.datatype2id.PYTHON=10,KBEngine.datatype2id.PY_DICT=10,KBEngine.datatype2id.PY_TUPLE=10,KBEngine.datatype2id.PY_LIST=10,KBEngine.datatype2id.MAILBOX=10,KBEngine.datatype2id.BLOB=11,KBEngine.datatype2id.UNICODE=12,KBEngine.datatype2id.FLOAT=13,KBEngine.datatype2id.DOUBLE=14,KBEngine.datatype2id.VECTOR2=15,KBEngine.datatype2id.VECTOR3=16,KBEngine.datatype2id.VECTOR4=17,KBEngine.datatype2id.FIXED_DICT=18,KBEngine.datatype2id.ARRAY=19},KBEngine.mappingDataType(),KBEngine.bindwriter=function(e,n){return n==KBEngine.datatype2id.UINT8?e.writeUint8:n==KBEngine.datatype2id.UINT16?e.writeUint16:n==KBEngine.datatype2id.UINT32?e.writeUint32:n==KBEngine.datatype2id.UINT64?e.writeUint64:n==KBEngine.datatype2id.INT8?e.writeInt8:n==KBEngine.datatype2id.INT16?e.writeInt16:n==KBEngine.datatype2id.INT32?e.writeInt32:n==KBEngine.datatype2id.INT64?e.writeInt64:n==KBEngine.datatype2id.FLOAT?e.writeFloat:n==KBEngine.datatype2id.DOUBLE?e.writeDouble:n==KBEngine.datatype2id.STRING?e.writeString:n==KBEngine.datatype2id.FIXED_DICT?e.writeStream:n==KBEngine.datatype2id.ARRAY?e.writeStream:e.writeStream},KBEngine.bindReader=function(e){return e==KBEngine.datatype2id.UINT8?KBEngine.reader.readUint8:e==KBEngine.datatype2id.UINT16?KBEngine.reader.readUint16:e==KBEngine.datatype2id.UINT32?KBEngine.reader.readUint32:e==KBEngine.datatype2id.UINT64?KBEngine.reader.readUint64:e==KBEngine.datatype2id.INT8?KBEngine.reader.readInt8:e==KBEngine.datatype2id.INT16?KBEngine.reader.readInt16:e==KBEngine.datatype2id.INT32?KBEngine.reader.readInt32:e==KBEngine.datatype2id.INT64?KBEngine.reader.readInt64:e==KBEngine.datatype2id.FLOAT?KBEngine.reader.readFloat:e==KBEngine.datatype2id.DOUBLE?KBEngine.reader.readDouble:e==KBEngine.datatype2id.STRING?KBEngine.reader.readString:e==KBEngine.datatype2id.PYTHON?KBEngine.reader.readStream:e==KBEngine.datatype2id.VECTOR2?KBEngine.reader.readStream:e==KBEngine.datatype2id.VECTOR3?KBEngine.reader.readStream:e==KBEngine.datatype2id.VECTOR4?KBEngine.reader.readStream:e==KBEngine.datatype2id.BLOB?KBEngine.reader.readStream:e==KBEngine.datatype2id.UNICODE?KBEngine.reader.readStream:e==KBEngine.datatype2id.FIXED_DICT?KBEngine.reader.readStream:e==KBEngine.datatype2id.ARRAY?KBEngine.reader.readStream:KBEngine.reader.readStream},KBEngine.Message=function(e,n,t,a,r,s){for(this.id=e,this.name=n,this.length=t,this.argsType=a,i=0;i<r.length;i++)r[i]=KBEngine.bindReader(r[i]);this.args=r,this.handler=s,this.createFromStream=function(e){if(this.args.length<=0)return e;var n=new Array(this.args.length);for(i=0;i<this.args.length;i++)n[i]=this.args[i].call(e);return n},this.handleMessage=function(e){return null==this.handler?void KBEngine.ERROR_MSG("KBEngine.Message::handleMessage: interface("+this.name+"/"+this.id+") no implement!"):void(this.args.length<=0?this.argsType<0?this.handler(e):this.handler():this.handler.apply(KBEngine.app,this.createFromStream(e)))}},KBEngine.messages={},KBEngine.messages.loginapp={},KBEngine.messages.baseapp={},KBEngine.clientmessages={},KBEngine.messages.Loginapp_importClientMessages=new KBEngine.Message(5,"importClientMessages",0,0,new Array,null),KBEngine.messages.Baseapp_importClientMessages=new KBEngine.Message(207,"importClientMessages",0,0,new Array,null),KBEngine.messages.Baseapp_importClientEntityDef=new KBEngine.Message(208,"importClientEntityDef",0,0,new Array,null),KBEngine.messages.onImportClientMessages=new KBEngine.Message(518,"onImportClientMessages",(-1),(-1),new Array,null),KBEngine.bufferedCreateEntityMessage={},KBEngine.Vector3=KBEngine.Class.extend({ctor:function(e,n,t){return this.x=e,this.y=n,this.z=t,!0},distance:function(e){var n=e.x-this.x,t=e.y-this.y,i=e.z-this.z;return Math.sqrt(n*n+t*t+i*i)}}),KBEngine.clampf=function(e,n,t){if(n>t){var i=n;n=t,t=i}return e<n?n:e<t?e:t},KBEngine.int82angle=function(e,n){return e*(Math.PI/(n?254:128))},KBEngine.angle2int8=function(e,n){var t=0;return t=n?KBEngine.clampf(floorf(254*e/float(Math.PI)+.5),-128,127):Math.floor(128*e/float(Math.PI)+.5)},KBEngine.Entity=KBEngine.Class.extend({ctor:function(){return this.id=0,this.className="",this.position=new KBEngine.Vector3(0,0,0),this.direction=new KBEngine.Vector3(0,0,0),this.velocity=0,this.cell=null,this.base=null,this.inWorld=!1,this.inited=!1,this.isControlled=!1,this.entityLastLocalPos=new KBEngine.Vector3(0,0,0),this.entityLastLocalDir=new KBEngine.Vector3(0,0,0),this.isOnGround=!1,!0},__init__:function(){},callPropertysSetMethods:function(){var e=KBEngine.moduledefs[this.className];for(t in e.propertys){var n=e.propertys[t],t=(n[0],n[2]),i=n[5],a=n[6],r=this[t];if(null!=i)if(32==a||64==a)this.inited&&!this.inWorld&&i.call(this,r);else if(this.inWorld){if((8==a||16==a)&&!this.isPlayer())continue;i.call(this,r)}}},onDestroy:function(){},onControlled:function(e){},isPlayer:function(){return this.id==KBEngine.app.entity_id},baseCall:function(){if(arguments.length<1)return void KBEngine.ERROR_MSG("KBEngine.Entity::baseCall: not fount interfaceName!");if(void 0==this.base)return void KBEngine.ERROR_MSG("KBEngine.Entity::baseCall: base is None!");var e=KBEngine.moduledefs[this.className].base_methods[arguments[0]];if(void 0==e)return void KBEngine.ERROR_MSG("KBEngine.Entity::baseCall: The server did not find the def_method("+this.className+"."+arguments[0]+")!");var n=e[0],t=e[3];if(arguments.length-1!=t.length)return void KBEngine.ERROR_MSG("KBEngine.Entity::baseCall: args("+(arguments.length-1)+"!= "+t.length+") size is error!");this.base.newMail(),this.base.bundle.writeUint16(n);try{for(var i=0;i<t.length;i++){if(!t[i].isSameType(arguments[i+1]))throw new Error("KBEngine.Entity::baseCall: arg["+i+"] is error!");t[i].addToStream(this.base.bundle,arguments[i+1])}}catch(a){return KBEngine.ERROR_MSG(a.toString()),KBEngine.ERROR_MSG("KBEngine.Entity::baseCall: args is error!"),void(this.base.bundle=null)}this.base.postMail()},cellCall:function(){if(arguments.length<1)return void KBEngine.ERROR_MSG("KBEngine.Entity::cellCall: not fount interfaceName!");if(void 0==this.cell)return void KBEngine.ERROR_MSG("KBEngine.Entity::cellCall: cell is None!");var e=KBEngine.moduledefs[this.className].cell_methods[arguments[0]];if(void 0==e)return void KBEngine.ERROR_MSG("KBEngine.Entity::cellCall: The server did not find the def_method("+this.className+"."+arguments[0]+")!");var n=e[0],t=e[3];if(arguments.length-1!=t.length)return void KBEngine.ERROR_MSG("KBEngine.Entity::cellCall: args("+(arguments.length-1)+"!= "+t.length+") size is error!");this.cell.newMail(),this.cell.bundle.writeUint16(n);try{for(var i=0;i<t.length;i++){if(!t[i].isSameType(arguments[i+1]))throw new Error("KBEngine.Entity::cellCall: arg["+i+"] is error!");t[i].addToStream(this.cell.bundle,arguments[i+1])}}catch(a){return KBEngine.ERROR_MSG(a.toString()),KBEngine.ERROR_MSG("KBEngine.Entity::cellCall: args is error!"),void(this.cell.bundle=null)}this.cell.postMail()},enterWorld:function(){KBEngine.INFO_MSG(this.className+"::enterWorld: "+this.id),this.inWorld=!0,this.onEnterWorld(),KBEngine.Event.fire("onEnterWorld",this)},onEnterWorld:function(){},leaveWorld:function(){KBEngine.INFO_MSG(this.className+"::leaveWorld: "+this.id),this.inWorld=!1,this.onLeaveWorld(),KBEngine.Event.fire("onLeaveWorld",this)},onLeaveWorld:function(){},enterSpace:function(){KBEngine.INFO_MSG(this.className+"::enterSpace: "+this.id),this.onEnterSpace(),KBEngine.Event.fire("onEnterSpace",this)},onEnterSpace:function(){},leaveSpace:function(){KBEngine.INFO_MSG(this.className+"::leaveSpace: "+this.id),this.onLeaveSpace(),KBEngine.Event.fire("onLeaveSpace",this)},onLeaveSpace:function(){},set_position:function(e){this.isPlayer()&&(KBEngine.app.entityServerPos.x=this.position.x,KBEngine.app.entityServerPos.y=this.position.y,KBEngine.app.entityServerPos.z=this.position.z),KBEngine.Event.fire("set_position",this)},onUpdateVolatileData:function(){},set_direction:function(e){KBEngine.Event.fire("set_direction",this)}}),KBEngine.MAILBOX_TYPE_CELL=0,KBEngine.MAILBOX_TYPE_BASE=1,KBEngine.Mailbox=function(){this.id=0,this.className="",this.type=KBEngine.MAILBOX_TYPE_CELL,this.networkInterface=KBEngine.app,this.bundle=null,this.isBase=function(){return this.type==KBEngine.MAILBOX_TYPE_BASE},this.isCell=function(){return this.type==KBEngine.MAILBOX_TYPE_CELL},this.newMail=function(){return null==this.bundle&&(this.bundle=new KBEngine.Bundle),this.type==KBEngine.MAILBOX_TYPE_CELL?this.bundle.newMessage(KBEngine.messages.Baseapp_onRemoteCallCellMethodFromClient):this.bundle.newMessage(KBEngine.messages.Base_onRemoteMethodCall),this.bundle.writeInt32(this.id),this.bundle},this.postMail=function(e){void 0==e&&(e=this.bundle),e.send(this.networkInterface),this.bundle==e&&(this.bundle=null)}},KBEngine.moduledefs={},KBEngine.datatypes={},KBEngine.DATATYPE_UINT8=function(){this.bind=function(){},this.createFromStream=function(e){return KBEngine.reader.readUint8.call(e)},this.addToStream=function(e,n){e.writeUint8(n)},this.parseDefaultValStr=function(v){return eval(v)},this.isSameType=function(e){return"number"==typeof e&&!(e<0||e>255)}},KBEngine.DATATYPE_UINT16=function(){this.bind=function(){},this.createFromStream=function(e){return KBEngine.reader.readUint16.call(e)},this.addToStream=function(e,n){e.writeUint16(n)},this.parseDefaultValStr=function(v){return eval(v)},this.isSameType=function(e){return"number"==typeof e&&!(e<0||e>65535)}},KBEngine.DATATYPE_UINT32=function(){this.bind=function(){},this.createFromStream=function(e){return KBEngine.reader.readUint32.call(e)},this.addToStream=function(e,n){e.writeUint32(n)},this.parseDefaultValStr=function(v){return eval(v)},this.isSameType=function(e){return"number"==typeof e&&!(e<0||e>4294967295)}},KBEngine.DATATYPE_UINT64=function(){this.bind=function(){},this.createFromStream=function(e){return KBEngine.reader.readUint64.call(e)},this.addToStream=function(e,n){e.writeUint64(n)},this.parseDefaultValStr=function(v){return eval(v)},this.isSameType=function(e){return e instanceof KBEngine.UINT64}},KBEngine.DATATYPE_INT8=function(){this.bind=function(){},this.createFromStream=function(e){return KBEngine.reader.readInt8.call(e)},this.addToStream=function(e,n){e.writeInt8(n)},this.parseDefaultValStr=function(v){return eval(v)},this.isSameType=function(e){return"number"==typeof e&&!(e<-128||e>127)}},KBEngine.DATATYPE_INT16=function(){this.bind=function(){},this.createFromStream=function(e){return KBEngine.reader.readInt16.call(e)},this.addToStream=function(e,n){e.writeInt16(n)},this.parseDefaultValStr=function(v){return eval(v)},this.isSameType=function(e){return"number"==typeof e&&!(e<-32768||e>32767)}},KBEngine.DATATYPE_INT32=function(){this.bind=function(){},this.createFromStream=function(e){return KBEngine.reader.readInt32.call(e)},this.addToStream=function(e,n){e.writeInt32(n)},this.parseDefaultValStr=function(v){return eval(v)},this.isSameType=function(e){return"number"==typeof e&&!(e<-2147483648||e>2147483647)}},KBEngine.DATATYPE_INT64=function(){this.bind=function(){},this.createFromStream=function(e){return KBEngine.reader.readInt64.call(e)},this.addToStream=function(e,n){e.writeInt64(n)},this.parseDefaultValStr=function(v){return eval(v)},this.isSameType=function(e){return e instanceof KBEngine.INT64}},KBEngine.DATATYPE_FLOAT=function(){this.bind=function(){},this.createFromStream=function(e){return KBEngine.reader.readFloat.call(e)},this.addToStream=function(e,n){e.writeFloat(n)},this.parseDefaultValStr=function(v){return eval(v)},this.isSameType=function(e){return"number"==typeof e}},KBEngine.DATATYPE_DOUBLE=function(){this.bind=function(){},this.createFromStream=function(e){return KBEngine.reader.readDouble.call(e)},this.addToStream=function(e,n){e.writeDouble(n)},this.parseDefaultValStr=function(v){return eval(v)},this.isSameType=function(e){return"number"==typeof e}},KBEngine.DATATYPE_STRING=function(){this.bind=function(){},this.createFromStream=function(e){return KBEngine.reader.readString.call(e)},this.addToStream=function(e,n){e.writeString(n)},this.parseDefaultValStr=function(v){return eval(v)},this.isSameType=function(e){return"string"==typeof e}},KBEngine.DATATYPE_VECTOR2=function(){this.bind=function(){},this.createFromStream=function(e){return KBEngine.CLIENT_NO_FLOAT?new KBEngine.Vector2(KBEngine.reader.readInt32.call(e),KBEngine.reader.readInt32.call(e),KBEngine.reader.readInt32.call(e)):new KBEngine.Vector2(KBEngine.reader.readFloat.call(e),KBEngine.reader.readFloat.call(e),KBEngine.reader.readFloat.call(e))},this.addToStream=function(e,n){KBEngine.CLIENT_NO_FLOAT?(e.writeInt32(n.x),e.writeInt32(n.y)):(e.writeFloat(n.x),e.writeFloat(n.y))},this.parseDefaultValStr=function(v){return eval(v)},this.isSameType=function(e){return!(!e instanceof KBEngine.Vector2)}},KBEngine.DATATYPE_VECTOR3=function(){this.bind=function(){},this.createFromStream=function(e){return KBEngine.CLIENT_NO_FLOAT?new KBEngine.Vector3(KBEngine.reader.readInt32.call(e),KBEngine.reader.readInt32.call(e),KBEngine.reader.readInt32.call(e)):new KBEngine.Vector3(KBEngine.reader.readFloat.call(e),KBEngine.reader.readFloat.call(e),KBEngine.reader.readFloat.call(e))},this.addToStream=function(e,n){KBEngine.CLIENT_NO_FLOAT?(e.writeInt32(n.x),e.writeInt32(n.y),e.writeInt32(n.z)):(e.writeFloat(n.x),e.writeFloat(n.y),e.writeFloat(n.z))},this.parseDefaultValStr=function(v){return eval(v)},this.isSameType=function(e){return!(!e instanceof KBEngine.Vector3)}},KBEngine.DATATYPE_VECTOR4=function(){this.bind=function(){},this.createFromStream=function(e){return KBEngine.CLIENT_NO_FLOAT?new KBEngine.Vector4(KBEngine.reader.readInt32.call(e),KBEngine.reader.readInt32.call(e),KBEngine.reader.readInt32.call(e)):new KBEngine.Vector4(KBEngine.reader.readFloat.call(e),KBEngine.reader.readFloat.call(e),KBEngine.reader.readFloat.call(e))},this.addToStream=function(e,n){KBEngine.CLIENT_NO_FLOAT?(e.writeInt32(n.x),e.writeInt32(n.y),e.writeInt32(n.z),e.writeInt32(n.w)):(e.writeFloat(n.x),e.writeFloat(n.y),e.writeFloat(n.z),e.writeFloat(n.w))},this.parseDefaultValStr=function(v){return eval(v)},this.isSameType=function(e){return!(!e instanceof KBEngine.Vector4)}},KBEngine.DATATYPE_PYTHON=function(){this.bind=function(){},this.createFromStream=function(e){},this.addToStream=function(e,n){},this.parseDefaultValStr=function(v){return eval(v)},this.isSameType=function(e){return!1}},KBEngine.DATATYPE_UNICODE=function(){this.bind=function(){},this.createFromStream=function(e){return KBEngine.utf8ArrayToString(KBEngine.reader.readBlob.call(e))},this.addToStream=function(e,n){e.writeBlob(KBEngine.stringToUTF8Bytes(n))},this.parseDefaultValStr=function(e){return"string"==typeof e?e:""},this.isSameType=function(e){return"string"==typeof e}},KBEngine.DATATYPE_MAILBOX=function(){this.bind=function(){},this.createFromStream=function(e){},this.addToStream=function(e,n){},this.parseDefaultValStr=function(v){return eval(v)},this.isSameType=function(e){return!1}},KBEngine.DATATYPE_BLOB=function(){this.bind=function(){},this.createFromStream=function(e){var n=KBEngine.reader.readUint32.call(e),t=new Uint8Array(e.buffer,e.rpos,n);return e.rpos+=n,t},this.addToStream=function(e,n){e.writeBlob(n)},this.parseDefaultValStr=function(v){return eval(v)},this.isSameType=function(e){return!0}},KBEngine.DATATYPE_ARRAY=function(){this.type=null,this.bind=function(){"number"==typeof this.type&&(this.type=KBEngine.datatypes[this.type])},this.createFromStream=function(e){for(var n=e.readUint32(),t=[];n>0;)n--,t.push(this.type.createFromStream(e));return t},this.addToStream=function(e,n){e.writeUint32(n.length);for(var t=0;t<n.length;t++)this.type.addToStream(e,n[t])},this.parseDefaultValStr=function(v){return eval(v)},this.isSameType=function(e){for(var n=0;n<e.length;n++)if(!this.type.isSameType(e[n]))return!1;return!0}},KBEngine.DATATYPE_FIXED_DICT=function(){this.dicttype={},this.implementedBy=null,this.bind=function(){for(itemkey in this.dicttype){var e=this.dicttype[itemkey];"number"==typeof this.dicttype[itemkey]&&(this.dicttype[itemkey]=KBEngine.datatypes[e])}},this.createFromStream=function(e){var n={};for(itemkey in this.dicttype)n[itemkey]=this.dicttype[itemkey].createFromStream(e);return n},this.addToStream=function(e,n){for(itemkey in this.dicttype)this.dicttype[itemkey].addToStream(e,n[itemkey])},this.parseDefaultValStr=function(v){return eval(v)},this.isSameType=function(e){for(itemkey in this.dicttype)if(!this.dicttype[itemkey].isSameType(e[itemkey]))return!1;return!0}},KBEngine.datatypes.UINT8=new KBEngine.DATATYPE_UINT8,KBEngine.datatypes.UINT16=new KBEngine.DATATYPE_UINT16,KBEngine.datatypes.UINT32=new KBEngine.DATATYPE_UINT32,KBEngine.datatypes.UINT64=new KBEngine.DATATYPE_UINT64,KBEngine.datatypes.INT8=new KBEngine.DATATYPE_INT8,KBEngine.datatypes.INT16=new KBEngine.DATATYPE_INT16,KBEngine.datatypes.INT32=new KBEngine.DATATYPE_INT32,KBEngine.datatypes.INT64=new KBEngine.DATATYPE_INT64,KBEngine.datatypes.FLOAT=new KBEngine.DATATYPE_FLOAT,KBEngine.datatypes.DOUBLE=new KBEngine.DATATYPE_DOUBLE,KBEngine.datatypes.STRING=new KBEngine.DATATYPE_STRING,KBEngine.datatypes.VECTOR2=new KBEngine.DATATYPE_VECTOR2,KBEngine.datatypes.VECTOR3=new KBEngine.DATATYPE_VECTOR3,KBEngine.datatypes.VECTOR4=new KBEngine.DATATYPE_VECTOR4,KBEngine.datatypes.PYTHON=new KBEngine.DATATYPE_PYTHON,KBEngine.datatypes.UNICODE=new KBEngine.DATATYPE_UNICODE,KBEngine.datatypes.MAILBOX=new KBEngine.DATATYPE_MAILBOX,KBEngine.datatypes.BLOB=new KBEngine.DATATYPE_BLOB,KBEngine.KBEngineArgs=function(){this.ip="127.0.0.1",this.port=20013,this.updateHZ=100,this.clientType=5,this.isOnInitCallPropertysSetMethods=!0},KBEngine.KBEngineApp=function(kbengineArgs){console.assert(null==KBEngine.app||void 0==KBEngine.app,"Assertion of KBEngine.app not is null"),KBEngine.app=this,this.args=kbengineArgs,this.username="testhtml51",this.password="123456",this.clientdatas="",this.encryptedKey="",this.loginappMessageImported=!1,this.baseappMessageImported=!1,this.serverErrorsDescrImported=!1,this.entitydefImported=!1,KBEngine.ServerErr=function(){this.name="",this.descr="",this.id=0},this.serverErrs={},this.ip=this.args.ip,this.port=this.args.port,this.baseappIP="",this.baseappPort=0,this.resetSocket=function(){try{if(void 0!=KBEngine.app.socket&&null!=KBEngine.app.socket){var e=KBEngine.app.socket;e.onclose=void 0,KBEngine.app.socket=null,e.close()}}catch(n){}},this.reset=function(){void 0!=KBEngine.app.entities&&null!=KBEngine.app.entities&&KBEngine.app.clearEntities(!0),KBEngine.app.resetSocket(),KBEngine.app.currserver="loginapp",KBEngine.app.currstate="create",KBEngine.app.serverdatas="",KBEngine.app.serverVersion="",KBEngine.app.serverScriptVersion="",KBEngine.app.serverProtocolMD5="",KBEngine.app.serverEntityDefMD5="",KBEngine.app.clientVersion="0.9.12",KBEngine.app.clientScriptVersion="0.1.0",KBEngine.app.entity_uuid=null,KBEngine.app.entity_id=0,KBEngine.app.entity_type="",KBEngine.app.entityServerPos=new KBEngine.Vector3(0,0,0),KBEngine.app.entities={},KBEngine.app.entityIDAliasIDList=[],KBEngine.app.controlledEntities=[],KBEngine.app.spacedata={},KBEngine.app.spaceID=0,KBEngine.app.spaceResPath="",KBEngine.app.isLoadedGeometry=!1;var e=new Date;KBEngine.app.lastTickTime=e.getTime(),KBEngine.app.lastTickCBTime=e.getTime(),KBEngine.mappingDataType(),KBEngine.app.component="client"},this.installEvents=function(){KBEngine.Event.register("createAccount",KBEngine.app,"createAccount"),KBEngine.Event.register("login",KBEngine.app,"login"),KBEngine.Event.register("reloginBaseapp",KBEngine.app,"reloginBaseapp"),KBEngine.Event.register("bindAccountEmail",KBEngine.app,"bindAccountEmail"),KBEngine.Event.register("newPassword",KBEngine.app,"newPassword")},this.uninstallEvents=function(){KBEngine.Event.deregister("reloginBaseapp",KBEngine.app),KBEngine.Event.deregister("login",KBEngine.app),KBEngine.Event.deregister("createAccount",KBEngine.app)},this.hello=function(){var e=new KBEngine.Bundle;"loginapp"==KBEngine.app.currserver?e.newMessage(KBEngine.messages.Loginapp_hello):e.newMessage(KBEngine.messages.Baseapp_hello),e.writeString(KBEngine.app.clientVersion),e.writeString(KBEngine.app.clientScriptVersion),e.writeBlob(KBEngine.app.encryptedKey),e.send(KBEngine.app)},this.player=function(){return KBEngine.app.entities[KBEngine.app.entity_id]},this.findEntity=function(e){return KBEngine.app.entities[e]},this.connect=function(e){console.assert(null==KBEngine.app.socket,"Assertion of socket not is null");try{KBEngine.app.socket=new WebSocket(e);
}catch(n){return KBEngine.ERROR_MSG("WebSocket init error!"),void KBEngine.Event.fire("onConnectionState",!1)}KBEngine.app.socket.binaryType="arraybuffer",KBEngine.app.socket.onopen=KBEngine.app.onopen,KBEngine.app.socket.onerror=KBEngine.app.onerror_before_onopen,KBEngine.app.socket.onmessage=KBEngine.app.onmessage,KBEngine.app.socket.onclose=KBEngine.app.onclose},this.disconnect=function(){KBEngine.app.resetSocket()},this.onopen=function(){KBEngine.INFO_MSG("connect success!"),KBEngine.app.socket.onerror=KBEngine.app.onerror_after_onopen,KBEngine.Event.fire("onConnectionState",!0)},this.onerror_before_onopen=function(e){KBEngine.ERROR_MSG("connect error:"+e.data),KBEngine.app.resetSocket(),KBEngine.Event.fire("onConnectionState",!1)},this.onerror_after_onopen=function(e){KBEngine.ERROR_MSG("connect error:"+e.data),KBEngine.app.resetSocket(),KBEngine.Event.fire("onDisconnected")},this.onmessage=function(e){var n=new KBEngine.MemoryStream(e.data);for(n.wpos=e.data.byteLength;n.rpos<n.wpos;){var t=n.readUint16(),i=KBEngine.clientmessages[t];if(i){var a=i.length;a==-1&&(a=n.readUint16(),65535==a&&(a=n.readUint32()));var r=n.wpos,s=n.rpos+a;n.wpos=s,i.handleMessage(n),n.wpos=r,n.rpos=s}else KBEngine.ERROR_MSG("KBEngineApp::onmessage["+KBEngine.app.currserver+"]: not found msg("+t+")!")}},this.onclose=function(){KBEngine.INFO_MSG("connect close:"+KBEngine.app.currserver),KBEngine.app.resetSocket(),KBEngine.Event.fire("onDisconnected")},this.send=function(e){KBEngine.app.socket.send(e)},this.close=function(){KBEngine.INFO_MSG("KBEngine::close()"),KBEngine.app.socket.close(),KBEngine.app.reset()},this.update=function(){if(null!=KBEngine.app.socket){var e=new Date;if((e.getTime()-KBEngine.app.lastTickTime)/1e3>15){if(KBEngine.app.lastTickCBTime<KBEngine.app.lastTickTime&&(KBEngine.ERROR_MSG("sendTick: Receive appTick timeout!"),KBEngine.app.socket.close()),"loginapp"==KBEngine.app.currserver){if(void 0!=KBEngine.messages.Loginapp_onClientActiveTick){var n=new KBEngine.Bundle;n.newMessage(KBEngine.messages.Loginapp_onClientActiveTick),n.send(KBEngine.app)}}else if(void 0!=KBEngine.messages.Baseapp_onClientActiveTick){var n=new KBEngine.Bundle;n.newMessage(KBEngine.messages.Baseapp_onClientActiveTick),n.send(KBEngine.app)}KBEngine.app.lastTickTime=e.getTime()}KBEngine.app.updatePlayerToServer()}},this.Client_onAppActiveTickCB=function(){var e=new Date;KBEngine.app.lastTickCBTime=e.getTime()},this.serverErr=function(e){var n=KBEngine.app.serverErrs[e];return void 0==n?"":n.name+" ["+n.descr+"]"},this.Client_onImportServerErrorsDescr=function(e){for(var n=e.readUint16();n>0;){n-=1;var t=new KBEngine.ServerErr;t.id=e.readUint16(),t.name=KBEngine.utf8ArrayToString(e.readBlob()),t.descr=KBEngine.utf8ArrayToString(e.readBlob()),KBEngine.app.serverErrs[t.id]=t,KBEngine.INFO_MSG("Client_onImportServerErrorsDescr: id="+t.id+", name="+t.name+", descr="+t.descr)}},this.onOpenLoginapp_login=function(){if(KBEngine.INFO_MSG("KBEngineApp::onOpenLoginapp_login: successfully!"),KBEngine.Event.fire("onConnectionState",!0),KBEngine.app.currserver="loginapp",KBEngine.app.currstate="login",KBEngine.app.loginappMessageImported)KBEngine.app.onImportClientMessagesCompleted();else{var e=new KBEngine.Bundle;e.newMessage(KBEngine.messages.Loginapp_importClientMessages),e.send(KBEngine.app),KBEngine.app.socket.onmessage=KBEngine.app.Client_onImportClientMessages,KBEngine.INFO_MSG("KBEngineApp::onOpenLoginapp_login: start importClientMessages ..."),KBEngine.Event.fire("Loginapp_importClientMessages")}},this.onOpenLoginapp_createAccount=function(){if(KBEngine.Event.fire("onConnectionState",!0),KBEngine.INFO_MSG("KBEngineApp::onOpenLoginapp_createAccount: successfully!"),KBEngine.app.currserver="loginapp",KBEngine.app.currstate="createAccount",KBEngine.app.loginappMessageImported)KBEngine.app.onImportClientMessagesCompleted();else{var e=new KBEngine.Bundle;e.newMessage(KBEngine.messages.Loginapp_importClientMessages),e.send(KBEngine.app),KBEngine.app.socket.onmessage=KBEngine.app.Client_onImportClientMessages,KBEngine.INFO_MSG("KBEngineApp::onOpenLoginapp_createAccount: start importClientMessages ..."),KBEngine.Event.fire("Loginapp_importClientMessages")}},this.onImportClientMessagesCompleted=function(){if(KBEngine.INFO_MSG("KBEngineApp::onImportClientMessagesCompleted: successfully!"),KBEngine.app.socket.onmessage=KBEngine.app.onmessage,KBEngine.app.hello(),"loginapp"==KBEngine.app.currserver){if(!KBEngine.app.serverErrorsDescrImported){KBEngine.INFO_MSG("KBEngine::onImportClientMessagesCompleted(): send importServerErrorsDescr!"),KBEngine.app.serverErrorsDescrImported=!0;var e=new KBEngine.Bundle;e.newMessage(KBEngine.messages.Loginapp_importServerErrorsDescr),e.send(KBEngine.app)}"login"==KBEngine.app.currstate?KBEngine.app.login_loginapp(!1):"resetpassword"==KBEngine.app.currstate?KBEngine.app.resetpassword_loginapp(!1):KBEngine.app.createAccount_loginapp(!1),KBEngine.app.loginappMessageImported=!0}else if(KBEngine.app.baseappMessageImported=!0,KBEngine.app.entitydefImported)KBEngine.app.onImportEntityDefCompleted();else{KBEngine.INFO_MSG("KBEngineApp::onImportClientMessagesCompleted: start importEntityDef ...");var e=new KBEngine.Bundle;e.newMessage(KBEngine.messages.Baseapp_importClientEntityDef),e.send(KBEngine.app),KBEngine.Event.fire("Baseapp_importClientEntityDef")}},this.createDataTypeFromStreams=function(e,n){var t=e.readUint16();for(KBEngine.INFO_MSG("KBEngineApp::createDataTypeFromStreams: importAlias(size="+t+")!");t>0;)t--,KBEngine.app.createDataTypeFromStream(e,n);for(datatype in KBEngine.datatypes)void 0!=KBEngine.datatypes[datatype]&&KBEngine.datatypes[datatype].bind()},this.createDataTypeFromStream=function(e,n){var t=e.readUint16(),i=e.readString(),a=e.readString();if(0==a.length&&(length="Null_"+t),n&&KBEngine.INFO_MSG("KBEngineApp::Client_onImportClientEntityDef: importAlias("+i+":"+a+")!"),"FIXED_DICT"==i){var r=new KBEngine.DATATYPE_FIXED_DICT,s=e.readUint8();for(r.implementedBy=e.readString();s>0;){s--;var o=e.readString(),p=e.readUint16();r.dicttype[o]=p}KBEngine.datatypes[a]=r}else if("ARRAY"==i){var g=e.readUint16(),r=new KBEngine.DATATYPE_ARRAY;r.type=g,KBEngine.datatypes[a]=r}else KBEngine.datatypes[a]=KBEngine.datatypes[i];KBEngine.datatypes[t]=KBEngine.datatypes[a],KBEngine.datatype2id[a]=t},this.Client_onImportClientEntityDef=function(stream){for(KBEngine.app.createDataTypeFromStreams(stream,!0);!stream.readEOF();){var scriptmodule_name=stream.readString(),scriptUtype=stream.readUint16(),propertysize=stream.readUint16(),methodsize=stream.readUint16(),base_methodsize=stream.readUint16(),cell_methodsize=stream.readUint16();KBEngine.INFO_MSG("KBEngineApp::Client_onImportClientEntityDef: import("+scriptmodule_name+"), propertys("+propertysize+"), clientMethods("+methodsize+"), baseMethods("+base_methodsize+"), cellMethods("+cell_methodsize+")!"),KBEngine.moduledefs[scriptmodule_name]={};var currModuleDefs=KBEngine.moduledefs[scriptmodule_name];currModuleDefs.name=scriptmodule_name,currModuleDefs.propertys={},currModuleDefs.methods={},currModuleDefs.base_methods={},currModuleDefs.cell_methods={},KBEngine.moduledefs[scriptUtype]=currModuleDefs;var self_propertys=currModuleDefs.propertys,self_methods=currModuleDefs.methods,self_base_methods=currModuleDefs.base_methods,self_cell_methods=currModuleDefs.cell_methods;try{var Class=eval("KBEngine."+scriptmodule_name)}catch(e){var Class=void 0}for(;propertysize>0;){propertysize--;var properUtype=stream.readUint16(),properFlags=stream.readUint32(),aliasID=stream.readInt16(),name=stream.readString(),defaultValStr=stream.readString(),utype=KBEngine.datatypes[stream.readUint16()],setmethod=null;void 0!=Class&&(setmethod=Class.prototype["set_"+name],void 0==setmethod&&(setmethod=null));var savedata=[properUtype,aliasID,name,defaultValStr,utype,setmethod,properFlags];self_propertys[name]=savedata,aliasID>=0?(self_propertys[aliasID]=savedata,currModuleDefs.usePropertyDescrAlias=!0):(self_propertys[properUtype]=savedata,currModuleDefs.usePropertyDescrAlias=!1),KBEngine.INFO_MSG("KBEngineApp::Client_onImportClientEntityDef: add("+scriptmodule_name+"), property("+name+"/"+properUtype+").")}for(;methodsize>0;){methodsize--;for(var methodUtype=stream.readUint16(),aliasID=stream.readInt16(),name=stream.readString(),argssize=stream.readUint8(),args=[];argssize>0;)argssize--,args.push(KBEngine.datatypes[stream.readUint16()]);var savedata=[methodUtype,aliasID,name,args];self_methods[name]=savedata,aliasID>=0?(self_methods[aliasID]=savedata,currModuleDefs.useMethodDescrAlias=!0):(self_methods[methodUtype]=savedata,currModuleDefs.useMethodDescrAlias=!1),KBEngine.INFO_MSG("KBEngineApp::Client_onImportClientEntityDef: add("+scriptmodule_name+"), method("+name+").")}for(;base_methodsize>0;){base_methodsize--;for(var methodUtype=stream.readUint16(),aliasID=stream.readInt16(),name=stream.readString(),argssize=stream.readUint8(),args=[];argssize>0;)argssize--,args.push(KBEngine.datatypes[stream.readUint16()]);self_base_methods[name]=[methodUtype,aliasID,name,args],KBEngine.INFO_MSG("KBEngineApp::Client_onImportClientEntityDef: add("+scriptmodule_name+"), base_method("+name+").")}for(;cell_methodsize>0;){cell_methodsize--;for(var methodUtype=stream.readUint16(),aliasID=stream.readInt16(),name=stream.readString(),argssize=stream.readUint8(),args=[];argssize>0;)argssize--,args.push(KBEngine.datatypes[stream.readUint16()]);self_cell_methods[name]=[methodUtype,aliasID,name,args],KBEngine.INFO_MSG("KBEngineApp::Client_onImportClientEntityDef: add("+scriptmodule_name+"), cell_method("+name+").")}try{defmethod=eval("KBEngine."+scriptmodule_name)}catch(e){KBEngine.ERROR_MSG("KBEngineApp::Client_onImportClientEntityDef: module("+scriptmodule_name+") not found!"),defmethod=void 0}for(name in currModuleDefs.propertys){var infos=currModuleDefs.propertys[name],properUtype=infos[0],aliasID=infos[1],name=infos[2],defaultValStr=infos[3],utype=infos[4];void 0!=defmethod&&(defmethod.prototype[name]=utype.parseDefaultValStr(defaultValStr))}for(name in currModuleDefs.methods){var infos=currModuleDefs.methods[name],properUtype=infos[0],aliasID=infos[1],name=infos[2],args=infos[3];void 0!=defmethod&&void 0==defmethod.prototype[name]&&KBEngine.WARNING_MSG(scriptmodule_name+":: method("+name+") no implement!")}}KBEngine.app.onImportEntityDefCompleted()},this.Client_onVersionNotMatch=function(e){KBEngine.app.serverVersion=e.readString(),KBEngine.ERROR_MSG("Client_onVersionNotMatch: verInfo="+KBEngine.app.clientVersion+" not match(server: "+KBEngine.app.serverVersion+")"),KBEngine.Event.fire("onVersionNotMatch",KBEngine.app.clientVersion,KBEngine.app.serverVersion)},this.Client_onScriptVersionNotMatch=function(e){KBEngine.app.serverScriptVersion=e.readString(),KBEngine.ERROR_MSG("Client_onScriptVersionNotMatch: verInfo="+KBEngine.app.clientScriptVersion+" not match(server: "+KBEngine.app.serverScriptVersion+")"),KBEngine.Event.fire("onScriptVersionNotMatch",KBEngine.app.clientScriptVersion,KBEngine.app.serverScriptVersion)},this.onImportEntityDefCompleted=function(){KBEngine.INFO_MSG("KBEngineApp::onImportEntityDefCompleted: successfully!"),KBEngine.app.entitydefImported=!0,KBEngine.app.login_baseapp(!1)},this.Client_onImportClientMessages=function(e){var n=new KBEngine.MemoryStream(e.data),t=n.readUint16();if(t==KBEngine.messages.onImportClientMessages.id){var i=n.readUint16(),a=n.readUint16();for(KBEngine.INFO_MSG("KBEngineApp::onImportClientMessages: start("+a+") ...!");a>0;){a--,t=n.readUint16(),i=n.readInt16();for(var r=n.readString(),s=n.readInt8(),o=n.readUint8(),p=new Array(o),g=0;g<o;g++)p[g]=n.readUint8();var E=null,B=r.indexOf("Client_")>=0;B&&(E=KBEngine.app[r],null==E||void 0==E?(KBEngine.WARNING_MSG("KBEngineApp::onImportClientMessages["+KBEngine.app.currserver+"]: interface("+r+"/"+t+") no implement!"),E=null):KBEngine.INFO_MSG("KBEngineApp::onImportClientMessages: import("+r+") successfully!")),r.length>0?(KBEngine.messages[r]=new KBEngine.Message(t,r,i,s,p,E),B?KBEngine.clientmessages[t]=KBEngine.messages[r]:KBEngine.messages[KBEngine.app.currserver][t]=KBEngine.messages[r]):KBEngine.messages[KBEngine.app.currserver][t]=new KBEngine.Message(t,r,i,s,p,E)}KBEngine.app.onImportClientMessagesCompleted()}else KBEngine.ERROR_MSG("KBEngineApp::onmessage: not found msg("+t+")!")},this.createAccount=function(e,n,t){KBEngine.app.username=e,KBEngine.app.password=n,KBEngine.app.clientdatas=t,KBEngine.app.createAccount_loginapp(!0)},this.createAccount_loginapp=function(e){if(e)KBEngine.INFO_MSG("KBEngineApp::createAccount_loginapp: start connect to ws://"+KBEngine.app.ip+":"+KBEngine.app.port+"!"),KBEngine.app.connect("ws://"+KBEngine.app.ip+":"+KBEngine.app.port),KBEngine.app.socket.onopen=KBEngine.app.onOpenLoginapp_createAccount;else{var n=new KBEngine.Bundle;n.newMessage(KBEngine.messages.Loginapp_reqCreateAccount),n.writeString(KBEngine.app.username),n.writeString(KBEngine.app.password),n.writeBlob(KBEngine.app.clientdatas),n.send(KBEngine.app)}},this.bindAccountEmail=function(e){var n=new KBEngine.Bundle;n.newMessage(KBEngine.messages.Baseapp_reqAccountBindEmail),n.writeInt32(KBEngine.app.entity_id),n.writeString(KBEngine.app.password),n.writeString(e),n.send(KBEngine.app)},this.newPassword=function(e,n){var t=new KBEngine.Bundle;t.newMessage(KBEngine.messages.Baseapp_reqAccountNewPassword),t.writeInt32(KBEngine.app.entity_id),t.writeString(e),t.writeString(n),t.send(KBEngine.app)},this.login=function(e,n,t){KBEngine.app.reset(),KBEngine.app.username=e,KBEngine.app.password=n,KBEngine.app.clientdatas=t,KBEngine.app.login_loginapp(!0)},this.login_loginapp=function(e){if(e)KBEngine.INFO_MSG("KBEngineApp::login_loginapp: start connect to ws://"+KBEngine.app.ip+":"+KBEngine.app.port+"!"),KBEngine.app.connect("ws://"+KBEngine.app.ip+":"+KBEngine.app.port),KBEngine.app.socket.onopen=KBEngine.app.onOpenLoginapp_login;else{var n=new KBEngine.Bundle;n.newMessage(KBEngine.messages.Loginapp_login),n.writeInt8(KBEngine.app.args.clientType),n.writeBlob(KBEngine.app.clientdatas),n.writeString(KBEngine.app.username),n.writeString(KBEngine.app.password),n.send(KBEngine.app)}},this.onOpenLoginapp_resetpassword=function(){if(KBEngine.INFO_MSG("KBEngineApp::onOpenLoginapp_resetpassword: successfully!"),KBEngine.app.currserver="loginapp",KBEngine.app.currstate="resetpassword",KBEngine.app.loginappMessageImported)KBEngine.app.onImportClientMessagesCompleted();else{var e=new KBEngine.Bundle;e.newMessage(KBEngine.messages.Loginapp_importClientMessages),e.send(KBEngine.app),KBEngine.app.socket.onmessage=KBEngine.app.Client_onImportClientMessages,KBEngine.INFO_MSG("KBEngineApp::onOpenLoginapp_resetpassword: start importClientMessages ...")}},this.reset_password=function(e){KBEngine.app.username=e,KBEngine.app.resetpassword_loginapp(!0)},this.resetpassword_loginapp=function(e){if(e)KBEngine.INFO_MSG("KBEngineApp::createAccount_loginapp: start connect to ws://"+KBEngine.app.ip+":"+KBEngine.app.port+"!"),KBEngine.app.connect("ws://"+KBEngine.app.ip+":"+KBEngine.app.port),KBEngine.app.socket.onopen=KBEngine.app.onOpenLoginapp_resetpassword;else{var n=new KBEngine.Bundle;n.newMessage(KBEngine.messages.Loginapp_reqAccountResetPassword),n.writeString(KBEngine.app.username),n.send(KBEngine.app)}},this.onOpenBaseapp=function(){if(KBEngine.INFO_MSG("KBEngineApp::onOpenBaseapp: successfully!"),KBEngine.app.currserver="baseapp",KBEngine.app.baseappMessageImported)KBEngine.app.onImportClientMessagesCompleted();else{var e=new KBEngine.Bundle;e.newMessage(KBEngine.messages.Baseapp_importClientMessages),e.send(KBEngine.app),KBEngine.app.socket.onmessage=KBEngine.app.Client_onImportClientMessages,KBEngine.Event.fire("Baseapp_importClientMessages")}},this.login_baseapp=function(e){if(e)KBEngine.Event.fire("onLoginBaseapp"),KBEngine.INFO_MSG("KBEngineApp::login_baseapp: start connect to ws://"+KBEngine.app.baseappIp+":"+KBEngine.app.baseappPort+"!"),KBEngine.app.connect("ws://"+KBEngine.app.baseappIp+":"+KBEngine.app.baseappPort),void 0!=KBEngine.app.socket&&null!=KBEngine.app.socket&&(KBEngine.app.socket.onopen=KBEngine.app.onOpenBaseapp);else{var n=new KBEngine.Bundle;n.newMessage(KBEngine.messages.Baseapp_loginBaseapp),n.writeString(KBEngine.app.username),n.writeString(KBEngine.app.password),n.send(KBEngine.app)}},this.reloginBaseapp=function(){KBEngine.app.resetSocket(),KBEngine.Event.fire("onReloginBaseapp"),KBEngine.INFO_MSG("KBEngineApp::reloginBaseapp: start connect to ws://"+KBEngine.app.baseappIp+":"+KBEngine.app.baseappPort+"!"),KBEngine.app.connect("ws://"+KBEngine.app.baseappIp+":"+KBEngine.app.baseappPort),void 0!=KBEngine.app.socket&&null!=KBEngine.app.socket&&(KBEngine.app.socket.onopen=KBEngine.app.onReOpenBaseapp)},this.onReOpenBaseapp=function(){KBEngine.INFO_MSG("KBEngineApp::onReOpenBaseapp: successfully!"),KBEngine.app.currserver="baseapp";var e=new KBEngine.Bundle;e.newMessage(KBEngine.messages.Baseapp_reloginBaseapp),e.writeString(KBEngine.app.username),e.writeString(KBEngine.app.password),e.writeUint64(KBEngine.app.entity_uuid),e.writeInt32(KBEngine.app.entity_id),e.send(KBEngine.app);var n=new Date;KBEngine.app.lastTickCBTime=n.getTime()},this.Client_onHelloCB=function(e){KBEngine.app.serverVersion=e.readString(),KBEngine.app.serverScriptVersion=e.readString(),KBEngine.app.serverProtocolMD5=e.readString(),KBEngine.app.serverEntityDefMD5=e.readString();var n=e.readInt32();KBEngine.INFO_MSG("KBEngineApp::Client_onHelloCB: verInfo("+KBEngine.app.serverVersion+"), scriptVerInfo("+KBEngine.app.serverScriptVersion+"), serverProtocolMD5("+KBEngine.app.serverProtocolMD5+"), serverEntityDefMD5("+KBEngine.app.serverEntityDefMD5+"), ctype("+n+")!");var t=new Date;KBEngine.app.lastTickCBTime=t.getTime()},this.Client_onLoginFailed=function(e){var n=e.readUint16();KBEngine.app.serverdatas=e.readBlob(),KBEngine.ERROR_MSG("KBEngineApp::Client_onLoginFailed: failedcode("+KBEngine.app.serverErrs[n].name+"), datas("+KBEngine.app.serverdatas.length+")!"),KBEngine.Event.fire("onLoginFailed",n)},this.Client_onLoginSuccessfully=function(e){var n=e.readString();KBEngine.app.username=n,KBEngine.app.baseappIp=e.readString(),KBEngine.app.baseappPort=e.readUint16(),KBEngine.app.serverdatas=e.readBlob(),KBEngine.INFO_MSG("KBEngineApp::Client_onLoginSuccessfully: accountName("+n+"), addr("+KBEngine.app.baseappIp+":"+KBEngine.app.baseappPort+"), datas("+KBEngine.app.serverdatas.length+")!"),KBEngine.app.disconnect(),KBEngine.app.login_baseapp(!0)},this.Client_onLoginBaseappFailed=function(e){KBEngine.ERROR_MSG("KBEngineApp::Client_onLoginBaseappFailed: failedcode("+KBEngine.app.serverErrs[e].name+")!"),KBEngine.Event.fire("onLoginBaseappFailed",e)},this.Client_onReloginBaseappFailed=function(e){KBEngine.ERROR_MSG("KBEngineApp::Client_onReloginBaseappFailed: failedcode("+KBEngine.app.serverErrs[e].name+")!"),KBEngine.Event.fire("onReloginBaseappFailed",e)},this.Client_onReloginBaseappSuccessfully=function(e){KBEngine.app.entity_uuid=e.readUint64(),KBEngine.DEBUG_MSG("KBEngineApp::Client_onReloginBaseappSuccessfully: "+KBEngine.app.username),KBEngine.Event.fire("onReloginBaseappSuccessfully")},this.entityclass={},this.getentityclass=function(entityType){var runclass=KBEngine.app.entityclass[entityType];if(void 0==runclass){if(runclass=eval("KBEngine."+entityType),void 0==runclass)return KBEngine.ERROR_MSG("KBEngineApp::getentityclass: entityType("+entityType+") is error!"),runclass;KBEngine.app.entityclass[entityType]=runclass}return runclass},this.Client_onCreatedProxies=function(e,n,t){KBEngine.INFO_MSG("KBEngineApp::Client_onCreatedProxies: eid("+n+"), entityType("+t+")!");var i=KBEngine.app.entities[n];if(KBEngine.app.entity_uuid=e,KBEngine.app.entity_id=n,void 0==i){var a=KBEngine.app.getentityclass(t);if(void 0==a)return;var i=new a;i.id=n,i.className=t,i.base=new KBEngine.Mailbox,i.base.id=n,i.base.className=t,i.base.type=KBEngine.MAILBOX_TYPE_BASE,KBEngine.app.entities[n]=i;var r=KBEngine.bufferedCreateEntityMessage[n];void 0!=r&&(KBEngine.app.Client_onUpdatePropertys(r),delete KBEngine.bufferedCreateEntityMessage[n]),i.__init__(),i.inited=!0,KBEngine.app.args.isOnInitCallPropertysSetMethods&&i.callPropertysSetMethods()}else{var r=KBEngine.bufferedCreateEntityMessage[n];void 0!=r&&(KBEngine.app.Client_onUpdatePropertys(r),delete KBEngine.bufferedCreateEntityMessage[n])}},this.getAoiEntityIDFromStream=function(e){var n=0;if(KBEngine.app.entityIDAliasIDList.Length>255)n=e.readInt32();else{var t=e.readUint8();if(KBEngine.app.entityIDAliasIDList.length<=t)return 0;n=KBEngine.app.entityIDAliasIDList[t]}return n},this.onUpdatePropertys_=function(e,n){var t=KBEngine.app.entities[e];if(void 0==t){var i=KBEngine.bufferedCreateEntityMessage[e];if(void 0!=i)return void KBEngine.ERROR_MSG("KBEngineApp::Client_onUpdatePropertys: entity("+e+") not found!");var a=new KBEngine.MemoryStream(n.buffer);return a.wpos=n.wpos,a.rpos=n.rpos-4,void(KBEngine.bufferedCreateEntityMessage[e]=a)}for(var r=KBEngine.moduledefs[t.className],s=r.propertys;n.length()>0;){var o=0;o=r.usePropertyDescrAlias?n.readUint8():n.readUint16();var p=s[o],g=p[5],E=p[6],B=p[4].createFromStream(n),l=t[p[2]];KBEngine.INFO_MSG("KBEngineApp::Client_onUpdatePropertys: "+t.className+"(id="+e+" "+p[2]+", val="+B+")!"),t[p[2]]=B,null!=g&&(32==E||64==E?t.inited&&g.call(t,l):t.inWorld&&g.call(t,l))}},this.Client_onUpdatePropertysOptimized=function(e){var n=KBEngine.app.getAoiEntityIDFromStream(e);KBEngine.app.onUpdatePropertys_(n,e)},this.Client_onUpdatePropertys=function(e){var n=e.readInt32();KBEngine.app.onUpdatePropertys_(n,e)},this.onRemoteMethodCall_=function(e,n){var t=KBEngine.app.entities[e];if(void 0==t)return void KBEngine.ERROR_MSG("KBEngineApp::Client_onRemoteMethodCall: entity("+e+") not found!");var i=0;i=KBEngine.moduledefs[t.className].useMethodDescrAlias?n.readUint8():n.readUint16();for(var a=KBEngine.moduledefs[t.className].methods[i],r=[],s=a[3],o=0;o<s.length;o++)r.push(s[o].createFromStream(n));void 0!=t[a[2]]?t[a[2]].apply(t,r):KBEngine.ERROR_MSG("KBEngineApp::Client_onRemoteMethodCall: entity("+e+") not found method("+a[2]+")!")},this.Client_onRemoteMethodCallOptimized=function(e){var n=KBEngine.app.getAoiEntityIDFromStream(e);KBEngine.app.onRemoteMethodCall_(n,e)},this.Client_onRemoteMethodCall=function(e){var n=e.readInt32();KBEngine.app.onRemoteMethodCall_(n,e)},this.Client_onEntityEnterWorld=function(e){var n=e.readInt32();KBEngine.app.entity_id>0&&n!=KBEngine.app.entity_id&&KBEngine.app.entityIDAliasIDList.push(n);var t;t=KBEngine.moduledefs.Length>255?e.readUint16():e.readUint8();var i=!0;e.length()>0&&(i=e.readInt8()),t=KBEngine.moduledefs[t].name,KBEngine.INFO_MSG("KBEngineApp::Client_onEntityEnterWorld: "+t+"("+n+"), spaceID("+KBEngine.app.spaceID+"), isOnGround("+i+")!");var a=KBEngine.app.entities[n];if(void 0==a){if(entityMessage=KBEngine.bufferedCreateEntityMessage[n],void 0==entityMessage)return void KBEngine.ERROR_MSG("KBEngineApp::Client_onEntityEnterWorld: entity("+n+") not found!");var r=KBEngine.app.getentityclass(t);if(void 0==r)return;var a=new r;a.id=n,a.className=t,a.cell=new KBEngine.Mailbox,a.cell.id=n,a.cell.className=t,a.cell.type=KBEngine.MAILBOX_TYPE_CELL,KBEngine.app.entities[n]=a,KBEngine.app.Client_onUpdatePropertys(entityMessage),delete KBEngine.bufferedCreateEntityMessage[n],a.isOnGround=i>0,a.__init__(),a.inited=!0,a.inWorld=!0,a.enterWorld(),KBEngine.app.args.isOnInitCallPropertysSetMethods&&a.callPropertysSetMethods(),a.set_direction(a.direction),a.set_position(a.position)}else a.inWorld||(a.cell=new KBEngine.Mailbox,a.cell.id=n,a.cell.className=t,a.cell.type=KBEngine.MAILBOX_TYPE_CELL,KBEngine.app.entityIDAliasIDList=[],KBEngine.app.entities={},KBEngine.app.entities[a.id]=a,a.set_direction(a.direction),a.set_position(a.position),KBEngine.app.entityServerPos.x=a.position.x,KBEngine.app.entityServerPos.y=a.position.y,KBEngine.app.entityServerPos.z=a.position.z,a.isOnGround=i>0,a.inWorld=!0,a.enterWorld(),KBEngine.app.args.isOnInitCallPropertysSetMethods&&a.callPropertysSetMethods())},this.Client_onEntityLeaveWorldOptimized=function(e){var n=KBEngine.app.getAoiEntityIDFromStream(e);KBEngine.app.Client_onEntityLeaveWorld(n)},this.Client_onEntityLeaveWorld=function(e){var n=KBEngine.app.entities[e];if(void 0==n)return void KBEngine.ERROR_MSG("KBEngineApp::Client_onEntityLeaveWorld: entity("+e+") not found!");if(n.inWorld&&n.leaveWorld(),KBEngine.app.entity_id>0&&e!=KBEngine.app.entity_id){for(var t=[],i=0;i<KBEngine.app.controlledEntities.length;i++)KBEngine.app.controlledEntities[i]!=e?t.push(KBEngine.app.controlledEntities[i]):KBEngine.Event.fire("onLoseControlledEntity");KBEngine.app.controlledEntities=t,delete KBEngine.app.entities[e];for(var a=[],i=0;i<KBEngine.app.entityIDAliasIDList.length;i++)KBEngine.app.entityIDAliasIDList[i]!=e&&a.push(KBEngine.app.entityIDAliasIDList[i]);KBEngine.app.entityIDAliasIDList=a}else KBEngine.app.clearSpace(!1),n.cell=null},this.Client_onEntityDestroyed=function(e){KBEngine.INFO_MSG("KBEngineApp::Client_onEntityDestroyed: entity("+e+")!");var n=KBEngine.app.entities[e];return void 0==n?void KBEngine.ERROR_MSG("KBEngineApp::Client_onEntityDestroyed: entity("+e+") not found!"):(n.inWorld&&(KBEngine.app.entity_id==e&&KBEngine.app.clearSpace(!1),n.leaveWorld()),void delete KBEngine.app.entities[e])},this.Client_onEntityEnterSpace=function(e){var n=e.readInt32();KBEngine.app.spaceID=e.readUint32();var t=!0;e.length()>0&&(t=e.readInt8());var i=KBEngine.app.entities[n];return void 0==i?void KBEngine.ERROR_MSG("KBEngineApp::Client_onEntityEnterSpace: entity("+n+") not found!"):(i.isOnGround=t,KBEngine.app.entityServerPos.x=i.position.x,KBEngine.app.entityServerPos.y=i.position.y,KBEngine.app.entityServerPos.z=i.position.z,void i.enterSpace())},this.Client_onEntityLeaveSpace=function(e){var n=KBEngine.app.entities[e];return void 0==n?void KBEngine.ERROR_MSG("KBEngineApp::Client_onEntityLeaveSpace: entity("+e+") not found!"):(KBEngine.app.clearSpace(!1),void n.leaveSpace())},this.Client_onKicked=function(e){KBEngine.ERROR_MSG("KBEngineApp::Client_onKicked: failedcode("+KBEngine.app.serverErrs[e].name+")!"),KBEngine.Event.fire("onKicked",e)},this.Client_onCreateAccountResult=function(e){var n=e.readUint16(),t=e.readBlob();return 0!=n?void KBEngine.ERROR_MSG("KBEngineApp::Client_onCreateAccountResult: "+KBEngine.app.username+" create is failed! code="+KBEngine.app.serverErrs[n].name+"!"):(KBEngine.Event.fire("onCreateAccountResult",n,t),void KBEngine.INFO_MSG("KBEngineApp::Client_onCreateAccountResult: "+KBEngine.app.username+" create is successfully!"))},this.Client_onControlEntity=function(e,n){var e=stream.readInt32(),t=KBEngine.app.entities[e];if(void 0==t)return void KBEngine.ERROR_MSG("KBEngineApp::Client_onControlEntity: entity("+e+") not found!");var i=0!=n;if(i)KBEngine.app.player().id!=t.id&&KBEngine.app.controlledEntities.push(t);else{for(var a=[],r=0;r<KBEngine.app.controlledEntities.length;r++)KBEngine.app.controlledEntities[r]!=t.id&&a.push(KBEngine.app.controlledEntities[r]);KBEngine.app.controlledEntities=a}t.isControlled=i;try{t.onControlled(i),KBEngine.Event.fire("onControlled",t,i)}catch(s){KBEngine.ERROR_MSG("KBEngine::Client_onControlEntity: entity id = '"+e+"', is controlled = '"+i+"', error = '"+s+"'")}},this.updatePlayerToServer=function(){var e=KBEngine.app.player();if(void 0!=e&&0!=e.inWorld&&0!=KBEngine.app.spaceID&&!e.isControlled){if(e.entityLastLocalPos.distance(e.position)>.001||e.entityLastLocalDir.distance(e.direction)>.001){e.entityLastLocalPos.x=e.position.x,e.entityLastLocalPos.y=e.position.y,e.entityLastLocalPos.z=e.position.z,e.entityLastLocalDir.x=e.direction.x,e.entityLastLocalDir.y=e.direction.y,e.entityLastLocalDir.z=e.direction.z;var n=new KBEngine.Bundle;n.newMessage(KBEngine.messages.Baseapp_onUpdateDataFromClient),n.writeFloat(e.position.x),n.writeFloat(e.position.y),n.writeFloat(e.position.z),n.writeFloat(e.direction.x),n.writeFloat(e.direction.y),n.writeFloat(e.direction.z),n.writeUint8(e.isOnGround),n.writeUint32(KBEngine.app.spaceID),n.send(KBEngine.app)}for(var t in KBEngine.app.controlledEntities){var a=KBEngine.app.controlledEntities[i];if(position=a.position,direction=a.direction,posHasChanged=a.entityLastLocalPos.distance(position)>.001,dirHasChanged=a.entityLastLocalDir.distance(direction)>.001,posHasChanged||dirHasChanged){a.entityLastLocalPos=position,a.entityLastLocalDir=direction;var n=new KBEngine.Bundle;n.newMessage(KBEngine.messages.Baseapp_onUpdateDataFromClientForControlledEntity),n.writeInt32(a.id),n.writeFloat(position.x),n.writeFloat(position.y),n.writeFloat(position.z),n.writeFloat(direction.x),n.writeFloat(direction.y),n.writeFloat(direction.z),n.writeUint8(a.isOnGround),n.writeUint32(KBEngine.app.spaceID),n.send(KBEngine.app)}}}},this.addSpaceGeometryMapping=function(e,n){KBEngine.INFO_MSG("KBEngineApp::addSpaceGeometryMapping: spaceID("+e+"), respath("+n+")!"),KBEngine.app.spaceID=e,KBEngine.app.spaceResPath=n,KBEngine.Event.fire("addSpaceGeometryMapping",n)},this.clearSpace=function(e){KBEngine.app.entityIDAliasIDList=[],KBEngine.app.spacedata={},KBEngine.app.clearEntities(e),KBEngine.app.isLoadedGeometry=!1,KBEngine.app.spaceID=0},this.clearEntities=function(e){if(KBEngine.app.controlledEntities=[],e){for(var n in KBEngine.app.entities)KBEngine.app.entities[n].inWorld&&KBEngine.app.entities[n].leaveWorld(),KBEngine.app.entities[n].onDestroy();KBEngine.app.entities={}}else{var t=KBEngine.app.player();for(var n in KBEngine.app.entities)n!=t.id&&(KBEngine.app.entities[n].inWorld&&KBEngine.app.entities[n].leaveWorld(),KBEngine.app.entities[n].onDestroy());KBEngine.app.entities={},KBEngine.app.entities[t.id]=t}},this.Client_initSpaceData=function(e){for(KBEngine.app.clearSpace(!1),KBEngine.app.spaceID=e.readInt32();e.length()>0;){var n=e.readString(),t=e.readString();KBEngine.app.Client_setSpaceData(KBEngine.app.spaceID,n,t)}KBEngine.INFO_MSG("KBEngineApp::Client_initSpaceData: spaceID("+KBEngine.app.spaceID+"), datas("+KBEngine.app.spacedata+")!")},this.Client_setSpaceData=function(e,n,t){KBEngine.INFO_MSG("KBEngineApp::Client_setSpaceData: spaceID("+e+"), key("+n+"), value("+t+")!"),KBEngine.app.spacedata[n]=t,"_mapping"==n&&KBEngine.app.addSpaceGeometryMapping(e,t),KBEngine.Event.fire("onSetSpaceData",e,n,t)},this.Client_delSpaceData=function(e,n){KBEngine.INFO_MSG("KBEngineApp::Client_delSpaceData: spaceID("+e+"), key("+n+")!"),delete KBEngine.app.spacedata[n],KBEngine.Event.fire("onDelSpaceData",e,n)},this.Client_getSpaceData=function(e,n){return KBEngine.app.spacedata[n]},this.Client_onUpdateBasePos=function(e,n,t){KBEngine.app.entityServerPos.x=e,KBEngine.app.entityServerPos.y=n,KBEngine.app.entityServerPos.z=t},this.Client_onUpdateBasePosXZ=function(e,n){KBEngine.app.entityServerPos.x=e,KBEngine.app.entityServerPos.z=n},this.Client_onUpdateData=function(e){var n=KBEngine.app.getAoiEntityIDFromStream(e),t=KBEngine.app.entities[n];if(void 0==t)return void KBEngine.ERROR_MSG("KBEngineApp::Client_onUpdateData: entity("+n+") not found!")},this.Client_onSetEntityPosAndDir=function(e){var n=e.readInt32(),t=KBEngine.app.entities[n];return void 0==t?void KBEngine.ERROR_MSG("KBEngineApp::Client_onSetEntityPosAndDir: entity("+n+") not found!"):(t.position.x=e.readFloat(),t.position.y=e.readFloat(),t.position.z=e.readFloat(),t.direction.x=e.readFloat(),t.direction.y=e.readFloat(),t.direction.z=e.readFloat(),t.entityLastLocalPos.x=t.position.x,t.entityLastLocalPos.y=t.position.y,t.entityLastLocalPos.z=t.position.z,t.entityLastLocalDir.x=t.direction.x,t.entityLastLocalDir.y=t.direction.y,t.entityLastLocalDir.z=t.direction.z,t.set_direction(t.direction),void t.set_position(t.position))},this.Client_onUpdateData_ypr=function(e){var n=KBEngine.app.getAoiEntityIDFromStream(e),t=e.readInt8(),i=e.readInt8(),a=e.readInt8();KBEngine.app._updateVolatileData(n,KBEngine.KBE_FLT_MAX,KBEngine.KBE_FLT_MAX,KBEngine.KBE_FLT_MAX,t,i,a,-1)},this.Client_onUpdateData_yp=function(e){var n=KBEngine.app.getAoiEntityIDFromStream(e),t=e.readInt8(),i=e.readInt8();KBEngine.app._updateVolatileData(n,KBEngine.KBE_FLT_MAX,KBEngine.KBE_FLT_MAX,KBEngine.KBE_FLT_MAX,t,i,KBEngine.KBE_FLT_MAX,-1);
},this.Client_onUpdateData_yr=function(e){var n=KBEngine.app.getAoiEntityIDFromStream(e),t=e.readInt8(),i=e.readInt8();KBEngine.app._updateVolatileData(n,KBEngine.KBE_FLT_MAX,KBEngine.KBE_FLT_MAX,KBEngine.KBE_FLT_MAX,t,KBEngine.KBE_FLT_MAX,i,-1)},this.Client_onUpdateData_pr=function(e){var n=KBEngine.app.getAoiEntityIDFromStream(e),t=e.readInt8(),i=e.readInt8();KBEngine.app._updateVolatileData(n,KBEngine.KBE_FLT_MAX,KBEngine.KBE_FLT_MAX,KBEngine.KBE_FLT_MAX,KBEngine.KBE_FLT_MAX,t,i,-1)},this.Client_onUpdateData_y=function(e){var n=KBEngine.app.getAoiEntityIDFromStream(e),t=e.readInt8();KBEngine.app._updateVolatileData(n,KBEngine.KBE_FLT_MAX,KBEngine.KBE_FLT_MAX,KBEngine.KBE_FLT_MAX,t,KBEngine.KBE_FLT_MAX,KBEngine.KBE_FLT_MAX,-1)},this.Client_onUpdateData_p=function(e){var n=KBEngine.app.getAoiEntityIDFromStream(e),t=e.readInt8();KBEngine.app._updateVolatileData(n,KBEngine.KBE_FLT_MAX,KBEngine.KBE_FLT_MAX,KBEngine.KBE_FLT_MAX,KBEngine.KBE_FLT_MAX,t,KBEngine.KBE_FLT_MAX,-1)},this.Client_onUpdateData_r=function(e){var n=KBEngine.app.getAoiEntityIDFromStream(e),t=e.readInt8();KBEngine.app._updateVolatileData(n,KBEngine.KBE_FLT_MAX,KBEngine.KBE_FLT_MAX,KBEngine.KBE_FLT_MAX,KBEngine.KBE_FLT_MAX,KBEngine.KBE_FLT_MAX,t,-1)},this.Client_onUpdateData_xz=function(e){var n=KBEngine.app.getAoiEntityIDFromStream(e),t=e.readPackXZ();KBEngine.app._updateVolatileData(n,t[0],KBEngine.KBE_FLT_MAX,t[1],KBEngine.KBE_FLT_MAX,KBEngine.KBE_FLT_MAX,KBEngine.KBE_FLT_MAX,1)},this.Client_onUpdateData_xz_ypr=function(e){var n=KBEngine.app.getAoiEntityIDFromStream(e),t=e.readPackXZ(),i=e.readInt8(),a=e.readInt8(),r=e.readInt8();KBEngine.app._updateVolatileData(n,t[0],KBEngine.KBE_FLT_MAX,t[1],i,a,r,1)},this.Client_onUpdateData_xz_yp=function(e){var n=KBEngine.app.getAoiEntityIDFromStream(e),t=e.readPackXZ(),i=e.readInt8(),a=e.readInt8();KBEngine.app._updateVolatileData(n,t[0],KBEngine.KBE_FLT_MAX,t[1],i,a,KBEngine.KBE_FLT_MAX,1)},this.Client_onUpdateData_xz_yr=function(e){var n=KBEngine.app.getAoiEntityIDFromStream(e),t=e.readPackXZ(),i=e.readInt8(),a=e.readInt8();KBEngine.app._updateVolatileData(n,t[0],KBEngine.KBE_FLT_MAX,t[1],i,KBEngine.KBE_FLT_MAX,a,1)},this.Client_onUpdateData_xz_pr=function(e){var n=KBEngine.app.getAoiEntityIDFromStream(e),t=e.readPackXZ(),i=e.readInt8(),a=e.readInt8();KBEngine.app._updateVolatileData(n,t[0],KBEngine.KBE_FLT_MAX,t[1],KBEngine.KBE_FLT_MAX,i,a,1)},this.Client_onUpdateData_xz_y=function(e){var n=KBEngine.app.getAoiEntityIDFromStream(e),t=e.readPackXZ(),i=e.readInt8();KBEngine.app._updateVolatileData(n,t[0],KBEngine.KBE_FLT_MAX,t[1],i,KBEngine.KBE_FLT_MAX,KBEngine.KBE_FLT_MAX,1)},this.Client_onUpdateData_xz_p=function(e){var n=KBEngine.app.getAoiEntityIDFromStream(e),t=e.readPackXZ(),i=e.readInt8();KBEngine.app._updateVolatileData(n,t[0],KBEngine.KBE_FLT_MAX,t[1],KBEngine.KBE_FLT_MAX,i,KBEngine.KBE_FLT_MAX,1)},this.Client_onUpdateData_xz_r=function(e){var n=KBEngine.app.getAoiEntityIDFromStream(e),t=e.readPackXZ(),i=e.readInt8();KBEngine.app._updateVolatileData(n,t[0],KBEngine.KBE_FLT_MAX,t[1],KBEngine.KBE_FLT_MAX,KBEngine.KBE_FLT_MAX,i,1)},this.Client_onUpdateData_xyz=function(e){var n=KBEngine.app.getAoiEntityIDFromStream(e),t=e.readPackXZ(),i=e.readPackY();KBEngine.app._updateVolatileData(n,t[0],i,t[1],KBEngine.KBE_FLT_MAX,KBEngine.KBE_FLT_MAX,KBEngine.KBE_FLT_MAX,0)},this.Client_onUpdateData_xyz_ypr=function(e){var n=KBEngine.app.getAoiEntityIDFromStream(e),t=e.readPackXZ(),i=e.readPackY(),a=e.readInt8(),r=e.readInt8(),s=e.readInt8();KBEngine.app._updateVolatileData(n,t[0],i,t[1],a,r,s,0)},this.Client_onUpdateData_xyz_yp=function(e){var n=KBEngine.app.getAoiEntityIDFromStream(e),t=e.readPackXZ(),i=e.readPackY(),a=e.readInt8(),r=e.readInt8();KBEngine.app._updateVolatileData(n,t[0],i,t[1],a,r,KBEngine.KBE_FLT_MAX,0)},this.Client_onUpdateData_xyz_yr=function(e){var n=KBEngine.app.getAoiEntityIDFromStream(e),t=e.readPackXZ(),i=e.readPackY(),a=e.readInt8(),r=e.readInt8();KBEngine.app._updateVolatileData(n,t[0],i,t[1],a,KBEngine.KBE_FLT_MAX,r,0)},this.Client_onUpdateData_xyz_pr=function(e){var n=KBEngine.app.getAoiEntityIDFromStream(e),t=(e.readPackXZ(),e.readPackY()),i=e.readInt8(),a=e.readInt8();KBEngine.app._updateVolatileData(n,x,t,z,KBEngine.KBE_FLT_MAX,i,a,0)},this.Client_onUpdateData_xyz_y=function(e){var n=KBEngine.app.getAoiEntityIDFromStream(e),t=e.readPackXZ(),i=e.readPackY(),a=e.readInt8();KBEngine.app._updateVolatileData(n,t[0],i,t[1],a,KBEngine.KBE_FLT_MAX,KBEngine.KBE_FLT_MAX,0)},this.Client_onUpdateData_xyz_p=function(e){var n=KBEngine.app.getAoiEntityIDFromStream(e),t=e.readPackXZ(),i=e.readPackY(),a=e.readInt8();KBEngine.app._updateVolatileData(n,t[0],i,t[1],KBEngine.KBE_FLT_MAX,a,KBEngine.KBE_FLT_MAX,0)},this.Client_onUpdateData_xyz_r=function(e){var n=KBEngine.app.getAoiEntityIDFromStream(e),t=e.readPackXZ(),i=e.readPackY();e.readInt8();KBEngine.app._updateVolatileData(n,t[0],i,t[1],r,KBEngine.KBE_FLT_MAX,KBEngine.KBE_FLT_MAX,0)},this._updateVolatileData=function(e,n,t,i,a,r,s,o){var p=KBEngine.app.entities[e];if(void 0==p)return void KBEngine.ERROR_MSG("KBEngineApp::_updateVolatileData: entity("+e+") not found!");o>=0&&(p.isOnGround=o>0);var g=!1;s!=KBEngine.KBE_FLT_MAX&&(g=!0,p.direction.x=KBEngine.int82angle(s,!1)),r!=KBEngine.KBE_FLT_MAX&&(g=!0,p.direction.y=KBEngine.int82angle(r,!1)),a!=KBEngine.KBE_FLT_MAX&&(g=!0,p.direction.z=KBEngine.int82angle(a,!1));var E=!1;1==g&&(KBEngine.Event.fire("set_direction",p),E=!0);var B=!1;n==KBEngine.KBE_FLT_MAX&&t==KBEngine.KBE_FLT_MAX&&i==KBEngine.KBE_FLT_MAX||(B=!0),n==KBEngine.KBE_FLT_MAX&&(n=0),t==KBEngine.KBE_FLT_MAX&&(t=0),i==KBEngine.KBE_FLT_MAX&&(i=0),B&&(p.position.x=n+KBEngine.app.entityServerPos.x,p.position.y=t+KBEngine.app.entityServerPos.y,p.position.z=i+KBEngine.app.entityServerPos.z,E=!0,KBEngine.Event.fire("updatePosition",p)),E&&p.onUpdateVolatileData()},this.Client_onStreamDataStarted=function(e,n,t){},this.Client_onStreamDataRecv=function(e){},this.Client_onStreamDataCompleted=function(e){},this.Client_onReqAccountResetPasswordCB=function(e){return 0!=e?void KBEngine.ERROR_MSG("KBEngineApp::Client_onReqAccountResetPasswordCB: "+KBEngine.app.username+" is failed! code="+KBEngine.app.serverErrs[e].name+"!"):void KBEngine.INFO_MSG("KBEngineApp::Client_onReqAccountResetPasswordCB: "+KBEngine.app.username+" is successfully!")},this.Client_onReqAccountBindEmailCB=function(e){return 0!=e?void KBEngine.ERROR_MSG("KBEngineApp::Client_onReqAccountBindEmailCB: "+KBEngine.app.username+" is failed! code="+KBEngine.app.serverErrs[e].name+"!"):void KBEngine.INFO_MSG("KBEngineApp::Client_onReqAccountBindEmailCB: "+KBEngine.app.username+" is successfully!")},this.Client_onReqAccountNewPasswordCB=function(e){return 0!=e?void KBEngine.ERROR_MSG("KBEngineApp::Client_onReqAccountNewPasswordCB: "+KBEngine.app.username+" is failed! code="+KBEngine.app.serverErrs[e].name+"!"):void KBEngine.INFO_MSG("KBEngineApp::Client_onReqAccountNewPasswordCB: "+KBEngine.app.username+" is successfully!")}},KBEngine.create=function(e){if(void 0==KBEngine.app){if(e.constructor!=KBEngine.KBEngineArgs)return void KBEngine.ERROR_MSG("KBEngine.create(): args("+e+") error! not is KBEngine.KBEngineArgs");new KBEngine.KBEngineApp(e),KBEngine.app.reset(),KBEngine.app.installEvents(),KBEngine.idInterval=setInterval(KBEngine.app.update,e.updateHZ)}},KBEngine.destroy=function(){void 0!=KBEngine.idInterval&&clearInterval(KBEngine.idInterval),void 0!=KBEngine.app&&(KBEngine.app.uninstallEvents(),KBEngine.app.reset(),KBEngine.app=void 0)},KBEngine.create2=KBEngine.Class.extend,cc.log("createKBE");var kbeargs=new KBEngine.KBEngineArgs;KBEngine.create(kbeargs),cc.log("ip:"+kbeargs.ip),KBEngine.Account=KBEngine.Entity.extend({__init__:function(){this._super(),this.regStat=0,KBEngine.Event.fire("onLoginSuccessfully",KBEngine.app.entity_uuid,this.id,this)},depositOne:function(){this.baseCall("depositOne")},depositTwo:function(){this.baseCall("depositTwo")},addMoney:function(e){this.baseCall("addMoney",e)},lessMoney:function(e){this.baseCall("lessMoney",e)},pressBarButton:function(){this.baseCall("pressBarButton")},pressBarButton:function(){this.baseCall("pressBarButton")},pressSevenButton:function(){this.baseCall("pressSevenButton")},pressStarButton:function(){this.baseCall("pressStarButton")},pressWatermelonButton:function(){this.baseCall("pressWatermelonButton")},pressBellButton:function(){this.baseCall("pressBellButton")},pressSnakemelonButton:function(){this.baseCall("pressSnakemelonButton")},pressOrangeButton:function(){this.baseCall("pressOrangeButton")},pressAppleButton:function(){this.baseCall("pressAppleButton")},pressStartButton:function(){this.baseCall("pressStartButton")},pressWinScoreToMoneyButton:function(){this.baseCall("pressWinScoreToMoneyButton")},pressClearButton:function(){this.baseCall("pressClearButton")},pressBigButton:function(){this.baseCall("pressBigButton")},pressSmallButton:function(){this.baseCall("pressSmallButton")},getAccountInfo:function(){this.baseCall("getAccountInfo")},onGetAccountInfo:function(e){KBEngine.Event.fire("onGetAccountInfo",e)}});